<!DOCTYPE html>
<html lang="mn">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Items Dashboard</title>
    <style>
      :root {
        --bg: #0b0f19;
        --panel: rgba(17, 24, 39, 0.8);
        --panel2: rgba(15, 23, 42, 0.92);
        --text: #e5e7eb;
        --muted: #9ca3af;
        --line: rgba(255, 255, 255, 0.1);
        --chip: rgba(255, 255, 255, 0.06);
        --good: #10b981;
        --bad: #ef4444;
        --warn: #f59e0b;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Arial;
        background: radial-gradient(
            1200px 600px at 30% -10%,
            rgba(59, 130, 246, 0.18),
            transparent 60%
          ),
          radial-gradient(
            900px 500px at 100% 0%,
            rgba(16, 185, 129, 0.14),
            transparent 55%
          ),
          var(--bg);
        color: var(--text);
      }
      a {
        color: inherit;
        text-decoration: none;
      }
      .wrap {
        max-width: 1280px;
        margin: 0 auto;
        padding: 16px;
      }

      .header {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
      }
      .title {
        font-size: 18px;
        font-weight: 800;
        letter-spacing: 0.2px;
      }
      .subtitle {
        color: var(--muted);
        font-size: 12px;
        margin-top: 4px;
      }

      .actions {
        display: flex;
        gap: 10px;
      }
      button {
        cursor: pointer;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        padding: 10px 12px;
        font-weight: 700;
      }
      button:hover {
        background: rgba(255, 255, 255, 0.12);
      }

      .controls {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 18px;
        padding: 12px;
        backdrop-filter: blur(10px);
      }
      .grid {
        display: grid;
        grid-template-columns: 1.4fr 1fr 1fr 1fr 1fr 1fr;
        gap: 10px;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
      }
      label.small {
        display: block;
        color: var(--muted);
        font-size: 11px;
        margin: 0 0 6px 2px;
      }
      input,
      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text);
        outline: none;
      }
      input::placeholder {
        color: rgba(229, 231, 235, 0.45);
      }

      .toggles {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-start;
        margin-top: 10px;
      }
      .toggle {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.04);
        padding: 8px 10px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
        user-select: none;
      }
      .toggle input {
        width: auto;
        margin: 0;
      }

      .hint {
        color: var(--muted);
        font-size: 12px;
        margin-top: 10px;
        line-height: 1.4;
      }

      .bar {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        margin: 12px 0 10px;
        flex-wrap: wrap;
      }
      .meta {
        color: var(--muted);
        font-size: 12px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .chips {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .chip {
        font-size: 12px;
        color: var(--muted);
        border: 1px solid var(--line);
        background: var(--chip);
        padding: 6px 10px;
        border-radius: 999px;
        white-space: nowrap;
      }

      .tablewrap {
        border: 1px solid var(--line);
        border-radius: 18px;
        overflow: hidden;
        background: var(--panel);
        backdrop-filter: blur(10px);
      }
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }
      thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: var(--panel2);
        border-bottom: 1px solid var(--line);
        text-align: left;
        font-size: 12px;
        color: var(--muted);
        padding: 10px 12px;
        white-space: nowrap;
      }
      tbody td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        font-size: 13px;
        white-space: nowrap;
        vertical-align: middle;
      }
      tbody tr:hover {
        background: rgba(255, 255, 255, 0.04);
      }

      .itemcell {
        display: flex;
        gap: 10px;
        align-items: center;
        min-width: 360px;
        max-width: 560px;
      }
      .imgwrap {
        width: 52px;
        height: 52px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.04);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 0 0 auto;
        position: relative;
      }
      .skel {
        width: 52px;
        height: 52px;
        border-radius: 14px;
        position: absolute;
        inset: 0;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.05);
      }
      .skel::after {
        content: "";
        position: absolute;
        inset: 0;
        transform: translateX(-100%);
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.12),
          transparent
        );
        animation: shimmer 1.1s infinite;
      }
      @keyframes shimmer {
        100% {
          transform: translateX(100%);
        }
      }

      img {
        width: 52px;
        height: 52px;
        object-fit: contain;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      img.loaded {
        opacity: 1;
      }
      .name {
        font-weight: 800;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 460px;
      }
      .sub {
        margin-top: 2px;
        color: var(--muted);
        font-size: 12px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 460px;
      }
      .num {
        font-variant-numeric: tabular-nums;
      }
      .good {
        color: var(--good);
        font-weight: 800;
      }
      .bad {
        color: var(--bad);
        font-weight: 800;
      }
      .warn {
        color: var(--warn);
        font-weight: 800;
      }

      @media (max-width: 980px) {
        .grid,
        .grid2 {
          grid-template-columns: 1fr 1fr;
        }
        .actions {
          width: 100%;
        }
        .itemcell {
          min-width: 280px;
        }
        .name,
        .sub {
          max-width: 240px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <div>
          <div class="title">Items Dashboard</div>
          <div class="subtitle">
            Sheet data → UI filters/sorts (Steam price optional)
          </div>
        </div>
        <div class="actions">
          <button id="refresh" type="button">Refresh</button>
          <button id="clear" type="button">Clear</button>
        </div>
      </div>

      <div class="controls">
        <div class="grid">
          <div>
            <label class="small">Search</label>
            <input id="q" placeholder="AK-47, Slate, AWP..." />
          </div>

          <div>
            <label class="small">Condition</label>
            <select id="cond">
              <option value="">All</option>
              <option>Factory New</option>
              <option>Minimal Wear</option>
              <option>Field-Tested</option>
              <option>Well-Worn</option>
              <option>Battle-Scarred</option>
            </select>
          </div>

          <div>
            <label class="small">Float min</label>
            <input id="fmin" placeholder="0.00" />
          </div>

          <div>
            <label class="small">Float max</label>
            <input id="fmax" placeholder="0.30" />
          </div>

          <div>
            <label class="small">Age (Received Ago)</label>
            <select id="age">
              <option value="">All</option>
              <option value="1">≤ 1 day</option>
              <option value="7">≤ 7 days</option>
              <option value="30">≤ 30 days</option>
              <option value="90">≤ 90 days</option>
            </select>
          </div>

          <div>
            <label class="small">Sort</label>
            <select id="sort">
              <option value="received_new">Received: newest</option>
              <option value="received_old">Received: oldest</option>
              <option value="sheet_asc">Sheet price ↑</option>
              <option value="sheet_desc">Sheet price ↓</option>
              <option value="float_asc">Float ↑</option>
              <option value="float_desc">Float ↓</option>
              <option value="name_asc">Name A→Z</option>
              <option value="name_desc">Name Z→A</option>
              <option value="steam_asc">Steam lowest ↑</option>
              <option value="steam_desc">Steam lowest ↓</option>
              <option value="diffpct_best">
                Best deals (Steam &lt; Sheet)
              </option>
              <option value="diffpct_worst">
                Worst deals (Steam &gt; Sheet)
              </option>
            </select>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label class="small">Sheet price min</label>
            <input id="pmin" placeholder="0" />
          </div>
          <div>
            <label class="small">Sheet price max</label>
            <input id="pmax" placeholder="999" />
          </div>

          <div>
            <label class="small">Steam lowest min</label>
            <input id="smin" placeholder="(Steam price ON үед)" />
          </div>
          <div>
            <label class="small">Steam lowest max</label>
            <input id="smax" placeholder="(Steam price ON үед)" />
          </div>

          <div>
            <label class="small">Diff% min</label>
            <input id="dmin" placeholder="-50" />
          </div>
          <div>
            <label class="small">Diff% max</label>
            <input id="dmax" placeholder="50" />
          </div>
        </div>

        <div class="toggles">
          <label class="toggle"
            ><input type="checkbox" id="onlyimg" /> Has image</label
          >
          <label class="toggle"
            ><input type="checkbox" id="steamprice" /> Include Steam
            price</label
          >
          <label class="toggle"
            ><input type="checkbox" id="dealonly" /> Deals only (Steam &lt;
            Sheet)</label
          >
          <label class="toggle"
            ><input type="checkbox" id="autorefresh" checked /> Auto refresh
            (60s)</label
          >
        </div>

        <div class="hint">
          Steam price OFF үед Steam-related filters (Steam min/max, Deals,
          Diff%) автоматаар үл тооцогдоно.
        </div>
      </div>

      <div class="bar">
        <div class="meta" id="status">Loading…</div>
        <div class="chips" id="chips"></div>
      </div>

      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Float</th>
              <th>Seed</th>
              <th class="num">Sheet</th>
              <th class="num">Steam Low</th>
              <th class="num">Steam Med</th>
              <th class="num">Diff%</th>
              <th>Received</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const el = (id) => document.getElementById(id);
      const statusEl = el("status");
      const chipsEl = el("chips");
      const tbody = el("tbody");

      function esc(s) {
        return String(s ?? "").replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }
      function num(x) {
        const n = Number(String(x ?? "").replace(/[^0-9.\-]/g, ""));
        return Number.isFinite(n) ? n : null;
      }
      function fmt2(n) {
        return n == null ? "—" : n.toFixed(2);
      }
      function fmtFloat(n) {
        return n == null ? "—" : n.toFixed(6);
      }
      function fmtPct(n) {
        if (n == null) return "—";
        const sign = n > 0 ? "+" : "";
        return sign + n.toFixed(1) + "%";
      }
      function marketUrl(marketName) {
        return (
          "https://steamcommunity.com/market/listings/730/" +
          encodeURIComponent(marketName || "")
        );
      }

      // Supported examples in your data: "7 days ago", "22 hours ago", "37 seconds ago", "1 hour ago"
      function agoToMinutes(s) {
        if (!s) return null;
        const t = String(s).toLowerCase();
        const m = t.match(
          /(\d+)\s*(second|minute|hour|day|week|month|year)s?\s+ago/
        );
        if (!m) return null;
        const v = Number(m[1]);
        const unit = m[2];
        const mult =
          unit === "second"
            ? 1 / 60
            : unit === "minute"
            ? 1
            : unit === "hour"
            ? 60
            : unit === "day"
            ? 1440
            : unit === "week"
            ? 10080
            : unit === "month"
            ? 43200
            : 525600;
        return v * mult;
      }

      function readState() {
        return {
          q: el("q").value.trim().toLowerCase(),
          cond: el("cond").value.trim(),
          fmin: num(el("fmin").value),
          fmax: num(el("fmax").value),
          pmin: num(el("pmin").value),
          pmax: num(el("pmax").value),
          smin: num(el("smin").value),
          smax: num(el("smax").value),
          dmin: num(el("dmin").value),
          dmax: num(el("dmax").value),
          age: el("age").value ? Number(el("age").value) : null,
          onlyimg: el("onlyimg").checked,
          includeSteam: el("steamprice").checked,
          dealonly: el("dealonly").checked,
          sort: el("sort").value,
          autorefresh: el("autorefresh").checked,
        };
      }

      function buildChips(state) {
        const chips = [];
        if (state.q) chips.push(["Search", state.q]);
        if (state.cond) chips.push(["Cond", state.cond]);
        if (state.fmin != null) chips.push(["Float ≥", state.fmin]);
        if (state.fmax != null) chips.push(["Float ≤", state.fmax]);
        if (state.pmin != null) chips.push(["Sheet ≥", state.pmin]);
        if (state.pmax != null) chips.push(["Sheet ≤", state.pmax]);
        if (state.age != null) chips.push(["Age ≤", state.age + "d"]);
        if (state.onlyimg) chips.push(["Has image", "true"]);
        if (state.includeSteam) chips.push(["Steam price", "on"]);
        if (state.includeSteam && state.dealonly)
          chips.push(["Deals", "Steam < Sheet"]);
        if (state.includeSteam && state.smin != null)
          chips.push(["Steam ≥", state.smin]);
        if (state.includeSteam && state.smax != null)
          chips.push(["Steam ≤", state.smax]);
        if (state.includeSteam && state.dmin != null)
          chips.push(["Diff% ≥", state.dmin]);
        if (state.includeSteam && state.dmax != null)
          chips.push(["Diff% ≤", state.dmax]);

        chipsEl.innerHTML = chips
          .map(([k, v]) => `<span class="chip">${esc(k)}: ${esc(v)}</span>`)
          .join("");
      }

      let data = [];
      let timer = null;

      async function load() {
        const state = readState();
        statusEl.textContent = state.includeSteam
          ? "Fetching (incl. Steam price)…"
          : "Fetching…";

        const url =
          "/api/items?t=" +
          Date.now() +
          (state.includeSteam ? "&include_price=1" : "");
        const r = await fetch(url);
        const j = await r.json();

        if (j.error) {
          statusEl.textContent = "Error: " + j.error;
          data = [];
          tbody.innerHTML = "";
          return;
        }

        data = Array.isArray(j.items) ? j.items : [];
        statusEl.textContent = `Loaded ${
          data.length
        } items • ${new Date().toLocaleString()}`;
        render();
      }

      function render() {
        const state = readState();
        buildChips(state);

        let items = data.slice();

        // Basic filters
        if (state.q) {
          items = items.filter((it) => {
            const mn = (it.marketName || "").toLowerCase();
            const n = (it.name || "").toLowerCase();
            const w = (it.wear || "").toLowerCase();
            return (
              mn.includes(state.q) || n.includes(state.q) || w.includes(state.q)
            );
          });
        }

        if (state.cond)
          items = items.filter(
            (it) => (it.row?.[1] || it.wear || "") === state.cond
          );
        if (state.onlyimg) items = items.filter((it) => !!it.imageUrl);

        if (state.fmin != null)
          items = items.filter(
            (it) => num(it.row?.[2]) != null && num(it.row?.[2]) >= state.fmin
          );
        if (state.fmax != null)
          items = items.filter(
            (it) => num(it.row?.[2]) != null && num(it.row?.[2]) <= state.fmax
          );

        // Sheet price from API or fallback to row[4] (your JSON shows sheetPrice exists :contentReference[oaicite:1]{index=1})
        if (state.pmin != null)
          items = items.filter(
            (it) =>
              (it.sheetPrice ?? num(it.row?.[4])) != null &&
              (it.sheetPrice ?? num(it.row?.[4])) >= state.pmin
          );
        if (state.pmax != null)
          items = items.filter(
            (it) =>
              (it.sheetPrice ?? num(it.row?.[4])) != null &&
              (it.sheetPrice ?? num(it.row?.[4])) <= state.pmax
          );

        // Age filter only when selected
        if (state.age != null) {
          const maxMin = state.age * 1440;
          items = items.filter((it) => {
            const mins = agoToMinutes(it.row?.[6]); // your data uses row[6] for "Received Ago" :contentReference[oaicite:2]{index=2}
            return mins != null && mins <= maxMin;
          });
        }

        // Steam-related filters only when includeSteam=true
        if (state.includeSteam) {
          if (state.smin != null)
            items = items.filter(
              (it) => it.steamLowest != null && it.steamLowest >= state.smin
            );
          if (state.smax != null)
            items = items.filter(
              (it) => it.steamLowest != null && it.steamLowest <= state.smax
            );

          if (state.dmin != null)
            items = items.filter(
              (it) => it.diffPct != null && it.diffPct >= state.dmin
            );
          if (state.dmax != null)
            items = items.filter(
              (it) => it.diffPct != null && it.diffPct <= state.dmax
            );

          if (state.dealonly) {
            items = items.filter(
              (it) =>
                it.steamLowest != null &&
                (it.sheetPrice ?? num(it.row?.[4])) != null &&
                it.steamLowest < (it.sheetPrice ?? num(it.row?.[4]))
            );
          }
        }

        // Sorting helpers
        const receivedKey = (it) => {
          const mins = agoToMinutes(it.row?.[6]);
          return mins == null ? 9e18 : mins; // smaller = newer
        };
        const sheetKey = (it) => it.sheetPrice ?? num(it.row?.[4]);
        const floatKey = (it) => num(it.row?.[2]);
        const nameKey = (it) => it.marketName || it.name || "";

        const steamKey = (it) => it.steamLowest ?? null;
        const diffKey = (it) => it.diffPct ?? null;

        const cmpNum = (x, y, dir = 1) => {
          if (x == null && y == null) return 0;
          if (x == null) return 1;
          if (y == null) return -1;
          return (x - y) * dir;
        };
        const cmpStr = (x, y, dir = 1) => {
          const a = String(x ?? "");
          const b = String(y ?? "");
          return a.localeCompare(b) * dir;
        };

        items.sort((a, b) => {
          const s = state.sort;
          if (s === "received_new")
            return cmpNum(receivedKey(a), receivedKey(b), 1);
          if (s === "received_old")
            return cmpNum(receivedKey(a), receivedKey(b), -1);
          if (s === "sheet_asc") return cmpNum(sheetKey(a), sheetKey(b), 1);
          if (s === "sheet_desc") return cmpNum(sheetKey(a), sheetKey(b), -1);
          if (s === "float_asc") return cmpNum(floatKey(a), floatKey(b), 1);
          if (s === "float_desc") return cmpNum(floatKey(a), floatKey(b), -1);
          if (s === "name_asc") return cmpStr(nameKey(a), nameKey(b), 1);
          if (s === "name_desc") return cmpStr(nameKey(a), nameKey(b), -1);

          // Steam sorts only meaningful when includeSteam
          if (s === "steam_asc") return cmpNum(steamKey(a), steamKey(b), 1);
          if (s === "steam_desc") return cmpNum(steamKey(a), steamKey(b), -1);
          if (s === "diffpct_best") return cmpNum(diffKey(a), diffKey(b), 1); // most negative first
          if (s === "diffpct_worst") return cmpNum(diffKey(a), diffKey(b), -1);
          return 0;
        });

        // Render table
        tbody.innerHTML = items
          .map((it) => {
            const r = Array.isArray(it.row) ? it.row : [];
            const condition = r[1] || it.wear || "—";
            const floatV = num(r[2]);
            const seed = r[3] || "—";
            const receivedAgo = r[6] || "—";

            const sheetP = it.sheetPrice ?? num(r[4]);
            const steamLow = it.steamLowest ?? null;
            const steamMed = it.steamMedian ?? null;
            const diffPct = it.diffPct ?? null;

            let diffClass = "";
            if (diffPct != null)
              diffClass = diffPct < 0 ? "good" : diffPct > 0 ? "bad" : "warn";

            const imgBlock = it.imageUrl
              ? `
          <div class="imgwrap">
            <div class="skel"></div>
            <img src="${esc(it.imageUrl)}" alt=""
                 loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous"
                 onload="this.classList.add('loaded'); this.previousElementSibling.style.display='none';"
                 onerror="this.previousElementSibling.style.display='none'; this.style.display='none';" />
          </div>
        `
              : `<div class="imgwrap"><span style="color:var(--muted);font-size:11px;">no img</span></div>`;

            return `
        <tr>
          <td>
            <div class="itemcell">
              ${imgBlock}
              <div style="min-width:0">
                <div class="name">
                  <a href="${esc(
                    marketUrl(it.marketName)
                  )}" target="_blank" rel="noreferrer">
                    ${esc(it.marketName || it.name || "—")}
                  </a>
                </div>
                <div class="sub">${esc(condition)} • Seed ${esc(seed)}</div>
              </div>
            </div>
          </td>

          <td class="num">${esc(fmtFloat(floatV))}</td>
          <td class="num">${esc(seed)}</td>
          <td class="num">${esc(fmt2(sheetP))}</td>
          <td class="num">${esc(fmt2(steamLow))}</td>
          <td class="num">${esc(fmt2(steamMed))}</td>
          <td class="num ${diffClass}">${esc(fmtPct(diffPct))}</td>
          <td>${esc(receivedAgo)}</td>
        </tr>
      `;
          })
          .join("");

        statusEl.textContent = `Showing ${items.length} / ${
          data.length
        } • ${new Date().toLocaleString()}`;
      }

      function applyAutoRefresh() {
        const state = readState();
        if (timer) clearInterval(timer);
        if (state.autorefresh) timer = setInterval(load, 60000);
      }

      function clearAll() {
        el("q").value = "";
        el("cond").value = "";
        el("fmin").value = "";
        el("fmax").value = "";
        el("age").value = "";
        el("sort").value = "received_new";

        el("pmin").value = "";
        el("pmax").value = "";
        el("smin").value = "";
        el("smax").value = "";
        el("dmin").value = "";
        el("dmax").value = "";

        el("onlyimg").checked = false;
        el("steamprice").checked = false;
        el("dealonly").checked = false;
        el("autorefresh").checked = true;

        applyAutoRefresh();
        load();
      }

      function wire() {
        const rerenderIds = [
          "q",
          "cond",
          "fmin",
          "fmax",
          "age",
          "sort",
          "pmin",
          "pmax",
          "smin",
          "smax",
          "dmin",
          "dmax",
          "onlyimg",
          "dealonly",
        ];
        rerenderIds.forEach((id) => {
          el(id).addEventListener("input", render);
          el(id).addEventListener("change", render);
        });

        el("steamprice").addEventListener("change", () => {
          // Steam price ON/OFF өөрчлөгдвөл data-г дахин татна
          load();
        });

        el("autorefresh").addEventListener("change", applyAutoRefresh);
        el("refresh").addEventListener("click", load);
        el("clear").addEventListener("click", clearAll);
      }

      wire();
      applyAutoRefresh();
      load();
    </script>
  </body>
</html>
